

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>第七章：大型程序的结构 &mdash; my_book_doc  文档</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../search.html" />
    <link rel="next" title="第八章：用户认证" href="ch8.html" />
    <link rel="prev" title="第六章：电子邮件" href="ch6.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> my_book_doc
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../python_book.html">python相关书籍</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../python_book.html#id1">python</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../python_book.html#web">web开发</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../python_web_development.html">python web开发实战—董伟明</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../flask_web_development.html">Flask Web开发(狗书)</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="ch1.html">第一章：安装</a></li>
<li class="toctree-l4"><a class="reference internal" href="ch2.html">第二章：程序基本结构</a></li>
<li class="toctree-l4"><a class="reference internal" href="ch3.html">第三章：模板</a></li>
<li class="toctree-l4"><a class="reference internal" href="ch4.html">第四章：web表单</a></li>
<li class="toctree-l4"><a class="reference internal" href="ch5.html">第五章：数据库</a></li>
<li class="toctree-l4"><a class="reference internal" href="ch6.html">第六章：电子邮件</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">第七章：大型程序的结构</a></li>
<li class="toctree-l4"><a class="reference internal" href="ch8.html">第八章：用户认证</a></li>
<li class="toctree-l4"><a class="reference internal" href="ch9.html">第九章：用户角色</a></li>
<li class="toctree-l4"><a class="reference internal" href="ch10.html">第十章：用户资料</a></li>
<li class="toctree-l4"><a class="reference internal" href="ch11.html">第十一章：博客文章</a></li>
<li class="toctree-l4"><a class="reference internal" href="ch12.html">第十二章：关注者</a></li>
<li class="toctree-l4"><a class="reference internal" href="ch13.html">第十三章：用户评论</a></li>
<li class="toctree-l4"><a class="reference internal" href="ch14.html">第十四章：应用编程接口</a></li>
<li class="toctree-l4"><a class="reference internal" href="ch15.html">第十五章：测试</a></li>
<li class="toctree-l4"><a class="reference internal" href="ch16.html">第十六章：性能</a></li>
<li class="toctree-l4"><a class="reference internal" href="ch17.html">第十七章：部署</a></li>
<li class="toctree-l4"><a class="reference internal" href="ch18.html">第十八章：其他资源</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../python_book.html#wxpython-qt">客户端开发(wxpython/qt)</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../security_book.html">安全相关书籍</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../asm_c_cjj_book.html">ASM/C/C++书籍</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../algorithm.html">算法相关书籍</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../database.html">数据库相关书籍</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ai.html">人工智能相关书籍</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mathematics.html">数学书</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../note/othor.html">笔记</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">my_book_doc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../python_book.html">python相关书籍</a> &raquo;</li>
        
          <li><a href="../flask_web_development.html">Flask Web开发(狗书)</a> &raquo;</li>
        
      <li>第七章：大型程序的结构</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>第七章：大型程序的结构<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<p><strong>这里组建大型项目结构，其实有更便捷的模板构建工具cookiecutter，省得每次项目都手动创建项目结构</strong></p>
<p>尽管在单一脚本中编写小型 Web 程序很方便,但这种方法并不能广泛使用。程序变复杂 后,使用单个大型源码文件会导致很多问题。
不同于大多数其他的 Web 框架,Flask 并不强制要求大型项目使用特定的组织方式,程序 结构的组织方式完全由开发者决定。在本章,我们将介绍一种使用包和模块组织大型程序 的方式。本书后续示例都将采用这种结构。</p>
<div class="section" id="id2">
<h2>配置选项<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>

    <span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;hard to guess string&#39;</span> 
    <span class="n">SQLALCHEMY_COMMIT_ON_TEARDOWN</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">FLASKY_MAIL_SUBJECT_PREFIX</span> <span class="o">=</span> <span class="s1">&#39;[Flasky]&#39;</span>
    <span class="n">FLASKY_MAIL_SENDER</span> <span class="o">=</span> <span class="s1">&#39;Flasky Admin &lt;flasky@example.com&gt;&#39;</span> 
    <span class="n">FLASKY_ADMIN</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FLASKY_ADMIN&#39;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="k">class</span> <span class="nc">DevelopmentConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span> 
    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">MAIL_SERVER</span> <span class="o">=</span> <span class="s1">&#39;smtp.googlemail.com&#39;</span>
    <span class="n">MAIL_PORT</span> <span class="o">=</span> <span class="mi">587</span>
    <span class="n">MAIL_USE_TLS</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">MAIL_USERNAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MAIL_USERNAME&#39;</span><span class="p">)</span>
    <span class="n">MAIL_PASSWORD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MAIL_PASSWORD&#39;</span><span class="p">)</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DEV_DATABASE_URL&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="s1">&#39;sqlite:///&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;data-dev.sqlite&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TestingConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span> 
    <span class="n">TESTING</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TEST_DATABASE_URL&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="s1">&#39;sqlite:///&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;data-test.sqlite&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ProductionConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DATABASE_URL&#39;</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="s1">&#39;sqlite:///&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;data.sqlite&#39;</span><span class="p">)</span>

<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;development&#39;</span><span class="p">:</span> <span class="n">DevelopmentConfig</span><span class="p">,</span> 
    <span class="s1">&#39;testing&#39;</span><span class="p">:</span> <span class="n">TestingConfig</span><span class="p">,</span> 
    <span class="s1">&#39;production&#39;</span><span class="p">:</span> <span class="n">ProductionConfig</span><span class="p">,</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="n">DevelopmentConfig</span> 
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>基类 Config 中包含通用配置,子类分别定义专用的配置。如果需要,你还可添加其他配 置类。</p>
<p>为了让配置方式更灵活且更安全,某些配置可以从环境变量中导入。
<strong>例如,SECRET_KEY 的值,</strong>
这是个敏感信息,可以在环境中设定,但系统也提供了一个默认值,以防环境中没有定义。</p>
<p>在 3 个子类中,SQLALCHEMY_DATABASE_URI 变量都被指定了不同的值。这样程序就可在不同 的配置环境中运行,每个环境都使用不同的数据库。</p>
<p>配置类可以定义 init_app() 类方法,其参数是程序实例。在这个方法中,可以执行对当前 环境的配置初始化。现在,基类 Config 中的 init_app() 方法为空。</p>
<p>在这个配置脚本末尾,config 字典中注册了不同的配置环境,而且还注册了一个默认配置 (本例的开发环境)。</p>
</div>
<div class="section" id="id3">
<h2>程序包<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>程序包用来保存程序的所有代码、模板和静态文件。我们可以把这个包直接称为 app(应 用),如果有需求,也可使用一个程序专用名字。templates 和 static 文件夹是程序包的一部 分,因此这两个文件夹被移到了 app 中。数据库模型和电子邮件支持函数也被移到了这个 包中,分别保存为 app/models.py 和 app/email.py。</p>
</div>
<div class="section" id="id4">
<h2>使用程序工厂函数<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>在单个文件中开发程序很方便,但却有个很大的缺点,因为程序在全局作用域中创建,所 以无法动态修改配置。运行脚本时,程序实例已经创建,再修改配置为时已晚。这一点对 单元测试尤其重要,因为有时为了提高测试覆盖度,必须在不同的配置环境中运行程序。</p>
<p>这个问题的解决方法是延迟创建程序实例,把创建过程移到可显式调用的工厂函数中。这 种方法不仅可以给脚本留出配置程序的时间,还能够创建多个程序实例,这些实例有时在 测试中非常有用。程序的工厂函数在 app 包的构造文件中定义</p>
<p>构造文件导入了大多数正在使用的 Flask 扩展。由于尚未初始化所需的程序实例,所以没 有初始化扩展,创建扩展类时没有向构造函数传入参数。create_app() 函数就是程序的工 厂函数,接受一个参数,是程序使用的配置名。配置类在 config.py 文件中定义,其中保存 的配置可以使用Flask app.config配置对象提供的from_object()方法直接导入程序。至 于配置对象,则可以通过名字从 config 字典中选择。程序创建并配置好后,就能初始化 扩展了。在之前创建的扩展对象上调用 init_app() 可以完成初始化过程。</p>
<p>app/__init__.py:程序包的构造文件:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span> 
<span class="kn">from</span> <span class="nn">flask.ext.bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span> 
<span class="kn">from</span> <span class="nn">flask.ext.mail</span> <span class="kn">import</span> <span class="n">Mail</span>
<span class="kn">from</span> <span class="nn">flask.ext.moment</span> <span class="kn">import</span> <span class="n">Moment</span>
<span class="kn">from</span> <span class="nn">flask.ext.sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span> 
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">config</span>

<span class="n">bootstrap</span> <span class="o">=</span> <span class="n">Bootstrap</span><span class="p">()</span>
<span class="n">mail</span> <span class="o">=</span> <span class="n">Mail</span><span class="p">()</span>
<span class="n">moment</span> <span class="o">=</span> <span class="n">Moment</span><span class="p">()</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">config_name</span><span class="p">):</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span> 
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">config_name</span><span class="p">])</span> 
    <span class="n">config</span><span class="p">[</span><span class="n">config_name</span><span class="p">]</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">bootstrap</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">moment</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="c1"># 附加路由和自定义的错误页面 </span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>
</div>
</div></blockquote>
<p>工厂函数返回创建的程序示例,不过要注意,现在工厂函数创建的程序还不完整,因为没 有路由和自定义的错误页面处理程序。这是下一节要讲的话题。</p>
</div>
<div class="section" id="id5">
<h2>在蓝本中实现程序功能<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<p>转换成程序工厂函数的操作让定义路由变复杂了。在单脚本程序中,程序实例存在于全 局作用域中,路由可以直接使用 app.route 修饰器定义。但现在程序在运行时创建,只 有调用 create_app() 之后才能使用 app.route 修饰器,这时定义路由就太晚了。和路由 一样,自定义的错误页面处理程序也面临相同的困难,因为错误页面处理程序使用 app. errorhandler 修饰器定义。</p>
<p>幸好 Flask 使用蓝本提供了更好的解决方法。蓝本和程序类似,也可以定义路由。不同的 是,在蓝本中定义的路由处于休眠状态,直到蓝本注册到程序上后,路由才真正成为程序 的一部分。使用位于全局作用域中的蓝本时,定义路由的方法几乎和单脚本程序一样。</p>
<p>和程序一样,蓝本可以在单个文件中定义,也可使用更结构化的方式在包中的多个模块中 创建。为了获得最大的灵活性,程序包中创建了一个子包,用于保存蓝本。示例 7-4 是这 个子包的构造文件,蓝本就创建于此。</p>
<p>app/main/__init__.py:创建蓝本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Blueprint</span>
<span class="n">main</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">views</span><span class="p">,</span> <span class="n">errors</span>
</pre></div>
</div>
<p>通过实例化一个 Blueprint 类对象可以创建蓝本。这个构造函数有两个必须指定的参数: 蓝本的名字和蓝本所在的包或模块。和程序一样,大多数情况下第二个参数使用 Python 的 __name__ 变量即可。</p>
<p>程序的路由保存在包里的 app/main/views.py 模块中,而错误处理程序保存在 app/main/ errors.py 模块中。导入这两个模块就能把路由和错误处理程序与蓝本关联起来。注意,这 些模块在 app/main/__init__.py 脚本的末尾导入,这是为了避免循环导入依赖,因为在 views.py 和 errors.py 中还要导入蓝本 main。</p>
<p>蓝本在工厂函数 create_app() 中注册到程序上:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">config_name</span><span class="p">):</span>
    <span class="c1">#...</span>
    <span class="kn">from</span> <span class="nn">.main</span> <span class="k">import</span> <span class="n">main</span> <span class="k">as</span> <span class="n">main_blueprint</span>
    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">main_blueprint</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span>
</pre></div>
</div>
<p>app/main/errors.py:蓝本中的错误处理程序:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">main</span>

<span class="nd">@main</span><span class="o">.</span><span class="n">app_errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">page_not_found</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;404.html&#39;</span><span class="p">),</span> <span class="mi">404</span>

<span class="nd">@main</span><span class="o">.</span><span class="n">app_errorhandler</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">internal_server_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;500.html&#39;</span><span class="p">),</span> <span class="mi">500</span>
</pre></div>
</div>
<p>在蓝本中编写错误处理程序稍有不同,如果使用 errorhandler 修饰器,那么只有蓝本中的错误才能触发处理程序。要想注册程序全局的错误处理程序,必须使用 app_errorhandler。</p>
<p>app/main/views.py:蓝本中定义的程序路由</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">main</span>
<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">NameForm</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">..models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="nd">@main.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">NameForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="c1"># ...</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;.index&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span>
        <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
        <span class="n">known</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;known&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span>
        <span class="n">current_time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
</pre></div>
</div>
</div></blockquote>
<p>在蓝本中编写视图函数主要有两点不同:第一,和前面的错误处理程序一样,路由修饰器 由蓝本提供;第二,url_for() 函数的用法不同。你可能还记得,url_for() 函数的第一 个参数是路由的端点名,在程序的路由中,默认为视图函数的名字。例如,在单脚本程序 中,index() 视图函数的 URL 可使用 url_for(‘index’) 获取。</p>
<p>在蓝本中就不一样了,Flask 会为蓝本中的全部端点加上一个命名空间,这样就可以在不
同的蓝本中使用相同的端点名定义视图函数,而不会产生冲突。命名空间就是蓝本的名字 (Blueprint 构造函数的第一个参数),所以视图函数 index() 注册的端点名是 main.index,其 URL 使用 url_for(‘main.index’) 获取。</p>
<p>url_for() 函数还支持一种简写的端点形式,在蓝本中可以省略蓝本名,例如url_for(‘. index’)。在这种写法中,命名空间是当前请求所在的蓝本。这意味着同一蓝本中的重定向 可以使用简写形式,但跨蓝本的重定向必须使用带有命名空间的端点名。</p>
<p>为了完全修改程序的页面,表单对象也要移到蓝本中,保存于 app/main/forms.py 模块。</p>
</div>
<div class="section" id="id6">
<h2>启动脚本<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<p>顶级文件夹中的 manage.py 文件用于启动程序。
manage.py:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">create_app</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">app.models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Role</span>
<span class="kn">from</span> <span class="nn">flask.ext.script</span> <span class="kn">import</span> <span class="n">Manager</span><span class="p">,</span> <span class="n">Shell</span>
<span class="kn">from</span> <span class="nn">flask.ext.migrate</span> <span class="kn">import</span> <span class="n">Migrate</span><span class="p">,</span> <span class="n">MigrateCommand</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;FLASK_CONFIG&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;default&#39;</span><span class="p">)</span> 
<span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">make_shell_context</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="o">=</span><span class="n">User</span><span class="p">,</span> <span class="n">Role</span><span class="o">=</span><span class="n">Role</span><span class="p">)</span>

<span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="n">Shell</span><span class="p">(</span><span class="n">make_context</span><span class="o">=</span><span class="n">make_shell_context</span><span class="p">))</span>
<span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="n">MigrateCommand</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">manager</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
<p>这个脚本先创建程序。如果已经定义了环境变量 FLASK_CONFIG,则从中读取配置名;否则 使用默认配置。然后初始化 Flask-Script、Flask-Migrate 和为 Python shell 定义的上下文。</p>
<p>出于便利,脚本中加入了 shebang 声明,所以在基于 Unix 的操作系统中可以通过 ./manage. py执行脚本,而不用使用复杂的python manage.py。</p>
</div>
<div class="section" id="id7">
<h2>需求文件<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h2>
<p>程序中必须包含一个 requirements.txt 文件,用于记录所有依赖包及其精确的版本号。如果 要在另一台电脑上重新生成虚拟环境,这个文件的重要性就体现出来了,例如部署程序时 使用的电脑。pip 可以使用如下命令自动生成这个文件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(venv) $ pip freeze &gt;requirements.txt
</pre></div>
</div>
<p><strong>安装或升级包后,最好更新这个文件。</strong></p>
<p>如果你要创建这个虚拟环境的完全副本,可以创建一个新的虚拟环境,并在其上运行以下 命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(venv) $ pip install -r requirements.txt
</pre></div>
</div>
<p>当你阅读本书时,该示例 requirements.txt 文件中的版本号可能已经过期了。如果愿意,你 可以试着使用这些包的最新版。如果遇到问题,你可以随时换回这个需求文件中的版本, 因为这些版本和程序兼容。</p>
</div>
<div class="section" id="id8">
<h2>单元测试<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h2>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span> 
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">create_app</span><span class="p">,</span> <span class="n">db</span>

<span class="k">class</span> <span class="nc">BasicsTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">(</span><span class="s1">&#39;testing&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_context</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app_context</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_app_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">current_app</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_app_is_testing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;TESTING&#39;</span><span class="p">])</span>

</pre></div>
</div>
</div></blockquote>
<p>这个测试使用 Python 标准库中的 unittest 包编写。setUp() 和 tearDown() 方法分别在各 测试前后运行,并且名字以 test_开头的函数都作为测试执行。</p>
<p>setUp() 方法尝试创建一个测试环境,类似于运行中的程序。首先,使用测试配置创建程 序,然后激活上下文。这一步的作用是确保能在测试中使用 current_app,像普通请求一 样。然后创建一个全新的数据库,以备不时之需。数据库和程序上下文在 tearDown() 方法 中删除。</p>
<p>第一个测试确保程序实例存在。第二个测试确保程序在测试配置中运行。若想把 tests 文 件夹作为包使用,需要添加 tests/__init__.py 文件,不过这个文件可以为空,因为 unittest 包会扫描所有模块并查找测试。</p>
<p>为了运行单元测试,你可以在 manage.py 脚本中添加一个自定义命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@manager</span><span class="o">.</span><span class="n">command</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Run the unit tests.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">unittest</span>
    <span class="n">tests</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestLoader</span><span class="p">()</span><span class="o">.</span><span class="n">discover</span><span class="p">(</span><span class="s1">&#39;tests&#39;</span><span class="p">)</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">TextTestRunner</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tests</span><span class="p">)</span>
</pre></div>
</div>
<p>manager.command 修饰器让自定义命令变得简单。修饰函数名就是命令名,函数的文档字符 串会显示在帮助消息中。test() 函数的定义体中调用了 unittest 包提供的测试运行函数。</p>
<p>单元测试可使用下面的命令运行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(venv) $ python manage.py test
test_app_exists (test_basics.BasicsTestCase) ... ok
test_app_is_testing (test_basics.BasicsTestCase) ... ok
.----------------------------------------------------------------------
Ran 2 tests in 0.001s
OK
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h2>创建数据库<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h2>
<p>重组后的程序和单脚本版本使用不同的数据库。</p>
<p>首选从环境变量中读取数据库的 URL,同时还提供了一个默认的 SQLite 数据库做备用。3 种配置环境中的环境变量名和 SQLite 数据库文件名都不一样。例如,在开发环境中,数据 库 URL 从环境变量 DEV_DATABASE_URL 中读取,如果没有定义这个环境变量,则使用名为 data-dev.sqlite 的 SQLite 数据库。</p>
<p>不管从哪里获取数据库 URL,都要在新数据库中创建数据表。如果使用 Flask-Migrate 跟 踪迁移,可使用如下命令创建数据表或者升级到最新修订版本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(venv) $ python manage.py db upgrade
</pre></div>
</div>
<p>不管你是否相信,第一部分到此就要结束了。现在你已经学到了使用 Flask 开发 Web 程序 的必备基础知识,不过可能还不确定如何把这些知识融贯起来开发一个真正的程序。本书 第二部分的目的就是解决这个问题,带着你一步一步地开发出一个完整的程序。</p>
<p><strong>广告区——博主提供付费服务，欢迎各位大佬来撩 ，提供IT咨询回答服务。快没饭吃了，大佬土豪 施舍点吧。联系方式：微信QQ电话均为18977771077.</strong></p>
<dl class="docutils">
<dt>赞助扫码::</dt>
<dd><a class="first reference internal image-reference" href="../../../_images/apay.jpg"><img alt="../../../_images/apay.jpg" src="../../../_images/apay.jpg" style="width: 198px; height: 216px;" /></a>
<a class="last reference internal image-reference" href="../../../_images/pay_wechat.png"><img alt="../../../_images/pay_wechat.png" src="../../../_images/pay_wechat.png" style="width: 226px; height: 212px;" /></a>
</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="ch8.html" class="btn btn-neutral float-right" title="第八章：用户认证" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="ch6.html" class="btn btn-neutral" title="第六章：电子邮件" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, anaf.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'',
            LANGUAGE:'zh_CN',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/translations.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>